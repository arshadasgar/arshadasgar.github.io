<!DOCTYPE html>
<html>
  <head>
    <title>VR Shooting Gallery V2</title>
    <meta name="description" content="A simple VR shooting game for the Meta Quest with a pistol and sounds.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      // --- Component for handling gun actions (like shooting sound) ---
      AFRAME.registerComponent('gun-handler', {
        init: function () {
          const el = this.el;
          const shootSound = document.querySelector('#shoot-sound');

          // Listen for the trigger press on the controller
          el.addEventListener('triggerdown', () => {
            // Play the shooting sound
            if (shootSound) {
              // We check if the sound component is ready and play it.
              if (shootSound.components.sound) {
                shootSound.components.sound.playSound();
              }
            }
          });
        }
      });

      // --- Component for making targets shootable and respawnable ---
      AFRAME.registerComponent('shootable-target', {
        init: function () {
          const el = this.el;
          const crackSound = document.querySelector('#crack-sound');

          el.addEventListener('click', () => {
            // --- Target Hit Logic ---
            
            // 1. Play the cracking sound effect.
            if (crackSound && crackSound.components.sound) {
              crackSound.components.sound.playSound();
            }
            
            // 2. Make the target invisible.
            el.setAttribute('visible', false);
            
            // 3. Emit event for the scorekeeper.
            el.sceneEl.emit('target-hit');

            // 4. Respawn the target after a 1-second delay.
            setTimeout(() => {
              this.respawnTarget();
            }, 1000);
          });
        },
        
        // --- Helper function to respawn the target at a new random location and size ---
        respawnTarget: function() {
          const el = this.el;
          
          // Define the spawn area.
          const spawnAreaX = 4.5;
          const spawnAreaY = 2.0;
          
          // Calculate new random coordinates.
          const newX = (Math.random() - 0.5) * 2 * spawnAreaX;
          const newY = (Math.random() * spawnAreaY) + 1;
          
          // Calculate a new random radius for the target.
          // This makes the diameter change randomly.
          const minRadius = 0.15;
          const maxRadius = 0.6;
          const newRadius = Math.random() * (maxRadius - minRadius) + minRadius;

          // Update the target's geometry (shape and size).
          el.setAttribute('geometry', {
            primitive: 'circle',
            radius: newRadius
          });
          
          // Set the new position.
          el.setAttribute('position', { x: newX, y: newY, z: -10 });
          
          // Make the target visible again.
          el.setAttribute('visible', true);
        }
      });

      // --- Component for managing the game score ---
      AFRAME.registerComponent('game-logic', {
        init: function() {
          this.score = 0;
          this.scoreText = document.querySelector('#scoreText');

          this.el.sceneEl.addEventListener('target-hit', () => {
            this.score++;
            this.scoreText.setAttribute('text', { value: 'Score: ' + this.score });
          });
        }
      });

    </script>
  </head>
  <body>
    <a-scene background="color: #2E2E2E" game-logic>

      <!-- Assets Management System: Preload models and sounds for better performance -->
      <a-assets>
        <!-- Pistol 3D Model from a reliable CDN -->
        <a-asset-item id="pistol-gltf" src="https://cdn.glitch.global/e499415f-4131-4936-8a8c-92a632b57a85/pistol.glb?v=1662499883937"></a-asset-item>
        
        <!-- Sound Effects -->
        <audio id="shoot-sound" src="https://cdn.glitch.global/e499415f-4131-4936-8a8c-92a632b57a85/gun-shot.wav?v=1662499877705" preload="auto"></audio>
        <audio id="crack-sound" src="https://cdn.glitch.global/e499415f-4131-4936-8a8c-92a632b57a85/target-crack.wav?v=1662499880499" preload="auto"></audio>
      </a-assets>

      <!-- Environment -->
      <a-sky color="#87CEEB"></a-sky>
      <a-plane position="0 0 -10" rotation="-90 0 0" width="20" height="20" color="#795548" shadow="receive: true"></a-plane>
      <a-box position="0 2.5 -10.5" width="10" height="5" depth="0.2" color="#4DB6AC" shadow="cast: false; receive: true"></a-box>

      <!-- Player and Controls -->
      <a-entity id="player-rig" position="0 0 2">
        <a-camera position="0 1.6 0"></a-camera>
        
        <!-- Right Hand Controller with Pistol -->
        <a-entity 
          oculus-touch-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: .target; far: 20;"
          gun-handler>
          
          <!-- Pistol Model: Replaces the old cylinder. We scale and position it to fit the hand. -->
          <a-gltf-model 
            src="#pistol-gltf" 
            position="0.05 -0.15 -0.3" 
            rotation="0 90 0" 
            scale="0.1 0.1 0.1">
          </a-gltf-model>
        </a-entity>

        <!-- Left hand -->
        <a-entity oculus-touch-controls="hand: left"></a-entity>
      </a-entity>

      <!-- Targets -->
      <!-- The geometry is now a 'circle' and the radius will be randomized on respawn. -->
      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.5;"
        material="color: #FFC107; side: double;"
        position="-3 2 -10"
        shadow="cast: true">
      </a-entity>

      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.25;"
        material="color: #E91E63; side: double;"
        position="3 3 -10"
        shadow="cast: true">
      </a-entity>

      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.7;"
        material="color: #2196F3; side: double;"
        position="0 1.5 -10"
        shadow="cast: true">
      </a-entity>
      
      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.4;"
        material="color: #4CAF50; side: double;"
        position="2 1 -10"
        shadow="cast: true">
      </a-entity>

      <!-- Score Display -->
      <a-text id="scoreText" value="Score: 0" position="-1 4 -6" color="white" align="center" width="4"></a-text>

    </a-scene>
  </body>
</html>
