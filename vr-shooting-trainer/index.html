<!DOCTYPE html>
<html>
  <head>
    <title>VR Shooting Gallery (Simplified)</title>
    <meta name="description" content="A simplified VR shooting game for debugging.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      // --- Component for making targets shootable and respawnable ---
      AFRAME.registerComponent('shootable-target', {
        init: function () {
          const el = this.el;

          el.addEventListener('click', () => {
            // --- Target Hit Logic ---

            // Play hit sound
            // const hitAudio = document.createElement('a-sound');
            // hitAudio.setAttribute('src', '#hitSound');
            // el.appendChild(hitAudio);
            // hitAudio.components.sound.playSound();
            
            // 1. Make the target invisible.
            el.setAttribute('visible', false);
            
            // 2. Emit event for the scorekeeper.
            el.sceneEl.emit('target-hit');

            // 3. Respawn the target after a 1-second delay.
            setTimeout(() => {
              // el.removeChild(hitAudio); // Remove sound entity after playing
              this.respawnTarget();
            }, 1000);
          });
        },
        
        // --- Helper function to respawn the target at a new random location and size ---
        respawnTarget: function() {
          const el = this.el;
          
          // Define the spawn area.
          const spawnAreaX = 4.5;
          const spawnAreaY = 2.0;
          
          // Calculate new random coordinates.
          const newX = (Math.random() - 0.5) * 2 * spawnAreaX;
          const newY = (Math.random() * spawnAreaY) + 1;
          
          // Calculate a new random radius for the target.
          const minRadius = 0.15;
          const maxRadius = 0.6;
          const newRadius = Math.random() * (maxRadius - minRadius) + minRadius;

          // Update the target's geometry (shape and size).
          el.setAttribute('geometry', {
            primitive: 'circle',
            radius: newRadius
          });
          
          // Set the new position.
          el.setAttribute('position', { x: newX, y: newY, z: -10 });
          
          // Make the target visible again.
          el.setAttribute('visible', true);
        }
      });

      // AFRAME.registerComponent('gun-sound', {
      //   init: function () {
      //     const gunEntity = this.el;
      //     const shootAudio = document.createElement('a-sound');
      //     shootAudio.setAttribute('src', '#shootSound');
      //     shootAudio.setAttribute('poolSize', 5); // Multiple rapid shots
      //     this.el.appendChild(shootAudio);

      //     // Listen for triggerdown event from controllers or mouse click for desktop
      //     this.el.addEventListener('triggerdown', () => {
      //       shootAudio.components.sound.stopSound();
      //       shootAudio.components.sound.playSound();
      //     });

      //     // For mouse users, also trigger sound on click
      //     gunEntity.addEventListener('click', () => {
      //       shootAudio.components.sound.stopSound();
      //       shootAudio.components.sound.playSound();
      //     });
      //   }
      // });

      // --- Component for managing the game score ---
      AFRAME.registerComponent('game-logic', {
        init: function() {
          this.score = 0;
          this.scoreText = document.querySelector('#scoreText');

          this.el.sceneEl.addEventListener('target-hit', () => {
            this.score++;
            this.scoreText.setAttribute('text', { value: 'Score: ' + this.score });
          });
        }
      });

    </script>
  </head>
  <body>
    <a-scene background="color: #2E2E2E" game-logic>

      <!-- All assets have been removed for debugging -->
      <a-assets>
        <audio id="shootSound" src="./assets/sounds/pistol_firing.mp3"></audio>
        <!-- <audio id="hitSound" src="https://cdn.jsdelivr.net/gh/hartzis/short-audio-files@main/hit.wav"></audio> -->
      </a-assets>
      <!-- Environment -->
      <a-sky color="#87CEEB"></a-sky>
      <a-plane position="0 0 -10" rotation="-90 0 0" width="20" height="20" color="#795548" shadow="receive: true"></a-plane>
      <a-box position="0 2.5 -10.5" width="10" height="5" depth="0.2" color="#4DB6AC" shadow="cast: false; receive: true"></a-box>

      <!-- Player and Controls -->
      <a-entity id="player-rig" position="0 0 2">
        <a-camera position="0 1.6 0"></a-camera>
        
        <!-- Right Hand Controller with simple cylinder "gun" -->
        <a-entity 
          oculus-touch-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: .target; far: 20;"
          gun-sound>
          
          <!-- Simple cylinder to act as the gun model -->
          <a-cylinder 
            position="0 -0.05 -0.3" 
            rotation="90 0 0" 
            radius="0.03" 
            height="0.3" 
            color="#333333">
          </a-cylinder>
        </a-entity>

        <!-- Left hand -->
        <a-entity oculus-touch-controls="hand: left"></a-entity>
      </a-entity>

      <!-- Targets -->
      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.5;"
        material="color: #FFC107; side: double;"
        position="-3 2 -10"
        shadow="cast: true">
      </a-entity>

      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.25;"
        material="color: #E91E63; side: double;"
        position="3 3 -10"
        shadow="cast: true">
      </a-entity>

      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.7;"
        material="color: #2196F3; side: double;"
        position="0 1.5 -10"
        shadow="cast: true">
      </a-entity>
      
      <a-entity class="target" shootable-target
        geometry="primitive: circle; radius: 0.4;"
        material="color: #4CAF50; side: double;"
        position="2 1 -10"
        shadow="cast: true">
      </a-entity>

      <!-- Score Display -->
      <a-text id="scoreText" value="Score: 0" position="-1 4 -6" color="white" align="center" width="4"></a-text>

    </a-scene>
  </body>
</html>
